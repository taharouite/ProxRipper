name: ProxRipper Auto Scraper

on:
  schedule:
    - cron: "*/15 * * * *"   # ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: proxripper
  cancel-in-progress: true

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ÙŠØ¶Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… GITHUB_TOKEN Ù„Ù„Ø¯ÙØ¹
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Ensure output dirs/files exist (first run safety)
        run: |
          mkdir -p full_proxies
          touch full_proxies/http.txt full_proxies/https.txt full_proxies/socks4.txt full_proxies/socks5.txt
          touch summary.json

      - name: Run ProxRipper
        run: |
          python ProxRipper.py
          echo "=== Proxy Stats ==="
          for proto in http https socks4 socks5; do
            if [ -f "full_proxies/$proto.txt" ]; then
              count=$(wc -l < "full_proxies/$proto.txt")
            else
              count=0
            fi
            echo "$proto: $count proxies"
          done

      - name: Commit & push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git add full_proxies/*.txt summary.json README.md || true
          git commit -m "Auto update proxies: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes"
          # ÙŠØ¯ÙØ¹ Ø¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙˆØ§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
          git push

      - name: Send Telegram Notification (if secrets exist)
        if: ${{ secrets.TELEGRAM_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
          RAW_BASE: https://raw.githubusercontent.com/${{ github.repository }}/main/full_proxies
          SITE_LINK: https://${{ github.repository_owner }}.github.io/ProxRipper/
        run: |
          TIMESTAMP=$(date '+%d %b %Y %H:%M:%S GMT+1')
          MESSAGE=$(cat <<-EOF
          ğŸŒ *ProxRipper Proxy Update*
          ğŸ•’ *Updated*: ${TIMESTAMP//./\\.}

          ğŸ“¥ *Download proxies directly*:

          \\- HTTP Proxies : [DOWNLOAD](${RAW_BASE}/http.txt)
          \\- HTTPS Proxies : [DOWNLOAD](${RAW_BASE}/https.txt)
          \\- SOCKS4 Proxies : [DOWNLOAD](${RAW_BASE}/socks4.txt)
          \\- SOCKS5 Proxies : [DOWNLOAD](${RAW_BASE}/socks5.txt)

          ğŸŒ *Visit our* [website](${SITE_LINK}) *to filter proxies by country*\\!
          EOF
          )
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=MarkdownV2 \
            --data-urlencode "text=${MESSAGE}"
    
